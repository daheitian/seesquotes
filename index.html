<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>即刻 RSS 内容展示</title>
  <!-- 核心：配置 CSP 策略，解决 eval 被阻止的问题 -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-eval' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    connect-src 'self' https://*.github.io https://rsshub.rssforever.com https://api.allorigins.win;
    media-src 'self';
    object-src 'none';
    base-uri 'self';
  ">
  <!-- 简单美化样式，适配移动端 -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    body {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
      line-height: 1.6;
      color: #333;
    }
    .loading {
      color: #666;
      padding: 20px;
      text-align: center;
    }
    .success {
      color: #28a745;
      margin-bottom: 15px;
    }
    .error {
      color: #dc3545;
      padding: 20px;
      text-align: center;
    }
    .rss-item {
      border-bottom: 1px solid #eee;
      padding: 15px 0;
    }
    .rss-item h3 {
      margin-bottom: 8px;
      font-size: 18px;
    }
    .rss-item a {
      color: #0366d6;
      text-decoration: none;
    }
    .rss-item a:hover {
      text-decoration: underline;
    }
    .rss-item .date {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- 加载状态提示 -->
  <div id="status" class="loading">正在连接即刻...</div>
  <!-- RSS 内容展示区域 -->
  <div id="rss-content"></div>

  <script>
    // ========== 配置项（请根据你的仓库修改） ==========
    const CONFIG = {
      // 1. 你的 GitHub Pages 缓存文件地址（替换为自己的仓库地址）
      cacheRssUrl: 'https://daheitian.github.io/data/jike-rss.xml',
      // 2. 降级用的 RSSHub 公共镜像地址（无需修改，或换其他可用镜像）
      fallbackRssUrl: 'https://rsshub.rssforever.com/jike/user/16120E35-EB4B-4FF1-9DBC-9BEFC1D16CCD',
      // 3. 请求超时时间（毫秒）
      timeout: 10000
    };

    // ========== 工具函数 ==========
    /**
     * 更新页面加载状态
     * @param {string} type - loading/success/error
     * @param {string} message - 提示文本
     */
    function updateStatus(type, message) {
      const statusEl = document.getElementById('status');
      statusEl.className = type;
      statusEl.textContent = message;
    }

    /**
     * 原生解析 XML（无 eval，避免 CSP 拦截）
     * @param {string} xmlText - XML 文本内容
     * @returns {Array} 解析后的 RSS 条目数组
     */
    function parseRssXml(xmlText) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
      
      // 检查 XML 解析是否出错
      const parseError = xmlDoc.querySelector('parsererror');
      if (parseError) {
        throw new Error('RSS 数据解析失败：XML 格式错误');
      }

      // 提取 RSS 条目
      const items = xmlDoc.querySelectorAll('item');
      const result = [];
      items.forEach(item => {
        result.push({
          title: item.querySelector('title')?.textContent || '无标题',
          link: item.querySelector('link')?.textContent || '#',
          pubDate: item.querySelector('pubDate')?.textContent || '无时间'
        });
      });
      return result;
    }

    /**
     * 渲染 RSS 内容到页面
     * @param {Array} rssItems - 解析后的 RSS 条目数组
     */
    function renderRssContent(rssItems) {
      const contentEl = document.getElementById('rss-content');
      if (rssItems.length === 0) {
        contentEl.innerHTML = '<div class="error">暂无即刻内容</div>';
        return;
      }

      // 拼接 HTML 内容
      let html = '';
      rssItems.forEach(item => {
        html += `
          <div class="rss-item">
            <h3><a href="${item.link}" target="_blank">${item.title}</a></h3>
            <div class="date">${item.pubDate}</div>
          </div>
        `;
      });
      contentEl.innerHTML = html;
    }

    /**
     * 通用请求函数（带超时）
     * @param {string} url - 请求地址
     * @returns {Promise<string>} 响应文本
     */
    async function requestWithTimeout(url) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.timeout);
      
      try {
        const response = await fetch(url, {
          method: 'GET',
          signal: controller.signal,
          headers: {
            'Accept': 'application/rss+xml, application/xml, text/xml',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }
        });

        clearTimeout(timeoutId);
        if (!response.ok) {
          throw new Error(`请求失败：${response.status}`);
        }
        return await response.text();
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('请求超时');
        }
        throw error;
      }
    }

    // ========== 核心逻辑：加载 RSS 数据 ==========
    async function loadRssData() {
      // 1. 优先加载 GitHub 缓存文件
      try {
        updateStatus('loading', '正在加载缓存数据...');
        const cacheData = await requestWithTimeout(CONFIG.cacheRssUrl);
        const rssItems = parseRssXml(cacheData);
        
        updateStatus('success', '缓存数据加载成功');
        renderRssContent(rssItems);
        return; // 缓存加载成功，终止逻辑
      } catch (cacheError) {
        console.warn('缓存加载失败：', cacheError.message);
        updateStatus('loading', '缓存加载失败，尝试降级请求...');
      }

      // 2. 缓存失败，降级请求 RSSHub 公共镜像
      try {
        const fallbackData = await requestWithTimeout(CONFIG.fallbackRssUrl);
        const rssItems = parseRssXml(fallbackData);
        
        updateStatus('success', '降级请求成功');
        renderRssContent(rssItems);
      } catch (fallbackError) {
        console.error('降级请求失败：', fallbackError.message);
        updateStatus('error', `加载失败：${fallbackError.message}`);
      }
    }

    // ========== 页面加载完成后执行 ==========
    window.onload = () => {
      loadRssData();
    };
  </script>
</body>
</html>
