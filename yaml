name: Sync Notion to JSON

on:
  schedule:
    - cron: '*/15 * * * *'  # 每15分钟运行一次
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Fetch Notion Data
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          # 创建输出目录
          mkdir -p dist
          
          # 调用 Notion API 获取数据库内容
          curl -X POST \
            "https://api.notion.com/v1/databases/${DATABASE_ID}/query" \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{
              "page_size": 100,
              "sorts": [{"timestamp": "created_time", "direction": "descending"}]
            }' > notion-raw.json
          
          # 检查 API 调用是否成功
          if [ "$(cat notion-raw.json | grep -c 'object')" -eq 0 ]; then
            echo "Error: Notion API call failed"
            cat notion-raw.json
            exit 1
          fi
          
          # 转换为小信号需要的格式
          node -e '
            const fs = require("fs");
            const raw = JSON.parse(fs.readFileSync("notion-raw.json", "utf8"));
            
            const posts = raw.results.map(page => {
              const props = page.properties;
              
              // 提取标题
              let title = "无标题";
              if (props.Name && props.Name.title) {
                title = props.Name.title.map(t => t.plain_text).join("");
              } else if (props.标题 && props.标题.title) {
                title = props.标题.title.map(t => t.plain_text).join("");
              }
              
              // 提取内容
              let content = "";
              if (props.Content && props.Content.rich_text) {
                content = props.Content.rich_text.map(t => t.plain_text).join("");
              } else if (props.内容 && props.内容.rich_text) {
                content = props.内容.rich_text.map(t => t.plain_text).join("");
              } else if (props.Note && props.Note.rich_text) {
                content = props.Note.rich_text.map(t => t.plain_text).join("");
              }
              
              // 提取标签
              let tags = [];
              if (props.Tags && props.Tags.multi_select) {
                tags = props.Tags.multi_select.map(t => t.name);
              } else if (props.标签 && props.标签.multi_select) {
                tags = props.标签.multi_select.map(t => t.name);
              } else if (props.Tag && props.Tag.multi_select) {
                tags = props.Tag.multi_select.map(t => t.name);
              }
              
              // 提取日期
              let date = page.created_time;
              if (props.Date && props.Date.date) {
                date = props.Date.date.start || page.created_time;
              } else if (props.日期 && props.日期.date) {
                date = props.日期.date.start || page.created_time;
              }
              
              // 提取图片（从页面属性或正文）
              let images = [];
              if (props.Images && props.Images.files) {
                images = props.Images.files
                  .filter(f => f.type === "external" || f.type === "file")
                  .map(f => f.external?.url || f.file?.url);
              }
              
              return {
                title: title,
                content: content,
                tags: tags,
                date: date,
                pubDate: date,
                author: "Notion",
                images: images,
                notionUrl: page.url
              };
            });
            
            fs.writeFileSync("dist/data.json", JSON.stringify(posts, null, 2));
            console.log("Converted " + posts.length + " posts");
          '
          
          # 复制到根目录供 GitHub Pages 使用
          cp dist/data.json data.json
          
          # 创建一个简单的索引页
          echo "<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Notion Sync</title></head><body><h1>Notion Sync API</h1><p>Data endpoint: <a href=\"data.json\">data.json</a></p><p>Last updated: $(date)</p></body></html>" > index.html
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
